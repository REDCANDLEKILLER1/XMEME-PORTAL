import React, { useState, useRef, useEffect } from 'react';
import * as THREE from 'three';
import { Upload, Download, ZoomIn, RefreshCw, Smartphone, Move, FileText, Save, Monitor, Play, FastForward, Zap } from 'lucide-react';

// --- Custom CSS for Glitch Effect ---
const GlitchStyles = () => (
  <style>{`
    @keyframes glitch {
      0% { text-shadow: 2px 2px #00ff00, -2px -2px #ff0000; transform: skew(0deg); }
      20% { text-shadow: -2px 2px #00ff00, 2px -2px #ff0000; transform: skew(-10deg); }
      40% { text-shadow: 2px -2px #00ff00, -2px 2px #ff0000; transform: skew(10deg); }
      60% { text-shadow: -2px -2px #00ff00, 2px 2px #ff0000; transform: skew(0deg); }
      80% { text-shadow: 2px 2px #00ff00, -2px -2px #ff0000; transform: skew(5deg); }
      100% { text-shadow: -2px -2px #00ff00, 2px 2px #ff0000; transform: skew(0deg); }
    }
    .glitch-text {
      position: relative;
      animation: glitch 2s infinite linear alternate-reverse;
    }
    .glitch-text::before, .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .glitch-text::before {
      left: 2px;
      text-shadow: -1px 0 #ff00c1;
      clip: rect(44px, 450px, 56px, 0);
      animation: glitch-anim-1 5s infinite linear alternate-reverse;
    }
    .glitch-text::after {
      left: -2px;
      text-shadow: -1px 0 #00fff9;
      clip: rect(44px, 450px, 56px, 0);
      animation: glitch-anim-2 5s infinite linear alternate-reverse;
    }
  `}</style>
);

// --- Vanilla Three.js Background Component ---
const ThreeBackground = () => {
  const mountRef = useRef(null);

  useEffect(() => {
    if (!mountRef.current) return;

    // 1. Setup Scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    scene.fog = new THREE.Fog(0x000000, 5, 30);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
    renderer.setSize(window.innerWidth, window.innerHeight);
    mountRef.current.appendChild(renderer.domElement);

    // 2. Create Tunnel
    const tunnelGroup = new THREE.Group();
    scene.add(tunnelGroup);

    const rings = [];
    const ringCount = 20;
    const geometry = new THREE.TorusGeometry(3, 0.05, 8, 50);
    const material = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });

    for (let i = 0; i < ringCount; i++) {
      const ring = new THREE.Mesh(geometry, material);
      ring.position.z = -i * 2;
      ring.userData = {
        rotationSpeed: (Math.random() - 0.5) * 0.02,
        originalScale: 1,
        offset: i
      };
      tunnelGroup.add(ring);
      rings.push(ring);
    }

    // 3. Create Stars
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 2000;
    const posArray = new Float32Array(starCount * 3);
    
    for(let i = 0; i < starCount * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 100;
    }
    
    starGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
    const starMaterial = new THREE.PointsMaterial({
        size: 0.1,
        color: 0xffffff,
        transparent: true,
        opacity: 0.6
    });
    const stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);

    // 4. Animation Loop
    let animationId;
    const animate = () => {
      animationId = requestAnimationFrame(animate);
      
      const time = Date.now() * 0.001;

      // Move Tunnel
      tunnelGroup.position.z += 0.05;
      if (tunnelGroup.position.z > 2) {
        tunnelGroup.position.z = 0;
      }

      // Rotate Rings
      rings.forEach((ring) => {
        ring.rotation.z += ring.userData.rotationSpeed;
        const scale = 1 + Math.sin(time * 2 + ring.userData.offset) * 0.05;
        ring.scale.set(scale, scale, scale);
      });

      // Float effect for stars
      stars.rotation.y = time * 0.05;

      renderer.render(scene, camera);
    };

    animate();

    // 5. Handle Resize
    const handleResize = () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', handleResize);

    // Cleanup
    return () => {
      window.removeEventListener('resize', handleResize);
      cancelAnimationFrame(animationId);
      if (mountRef.current && renderer.domElement) {
        mountRef.current.removeChild(renderer.domElement);
      }
      geometry.dispose();
      material.dispose();
    };
  }, []);

  return <div ref={mountRef} className="fixed inset-0 z-0" />;
};

// --- Main Application Logic ---
const App = () => {
  // Intro States: 'start' -> 'video' -> 'app'
  const [appState, setAppState] = useState('start'); 
  
  const [image, setImage] = useState(null);
  const [scale, setScale] = useState(1);
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const [startPan, setStartPan] = useState({ x: 0, y: 0 });
  const [ringThickness, setRingThickness] = useState(15);
  const [fileName, setFileName] = useState('XRP_PFP_01');
  
  // Pinch Zoom Ref
  const lastPinchDistance = useRef(null);
  
  // Resolution State
  const [resolution, setResolution] = useState(1080);
  
  const canvasRef = useRef(null);
  const containerRef = useRef(null);
  const fileInputRef = useRef(null);
  const videoRef = useRef(null);

  // Constants
  const BASE_SIZE = 800; 
  const NEON_GREEN = '#00ff00';
  const SPLASH_VIDEO_URL = "https://jade-adverse-damselfly-13.mypinata.cloud/ipfs/bafybeibg4vsibmytdleguujbhx7jcgythrkqcslszgr7aq7c5ms4mxaydy";

  const resolutionOptions = [
    { label: 'HD (1080px)', value: 1080 },
    { label: '2K (2160px)', value: 2160 },
    { label: '4K (4096px)', value: 4096 },
  ];

  // --- Intro Handlers ---
  const handleStart = () => {
    setAppState('video');
    setTimeout(() => {
        if (videoRef.current) {
            videoRef.current.play().catch(e => console.log("Video Play Error", e));
        }
    }, 100);
  };

  const handleSkip = () => {
    setAppState('app');
  };

  const handleVideoEnd = () => {
    setAppState('app');
  };

  // --- Main App Logic ---

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          setImage(img);
          setScale(1);
          setPosition({ x: 0, y: 0 });
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  const draw = () => {
    const canvas = canvasRef.current;
    if (!canvas || !image) return;

    const ctx = canvas.getContext('2d');
    const currentSize = resolution;
    const ratio = currentSize / BASE_SIZE;

    ctx.clearRect(0, 0, currentSize, currentSize);

    // Background (Black)
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, currentSize, currentSize);

    // 1. Draw User Image with Transforms
    ctx.save();
    ctx.translate(
      (currentSize / 2) + (position.x * ratio), 
      (currentSize / 2) + (position.y * ratio)
    );
    ctx.scale(scale * ratio, scale * ratio);
    
    ctx.drawImage(image, -image.width / 2, -image.height / 2);
    ctx.restore();

    // 2. Draw Black Mask (The Void)
    ctx.save();
    const scaledThickness = ringThickness * ratio;
    const center = currentSize / 2;
    const radius = center - (scaledThickness / 2);

    ctx.beginPath();
    ctx.rect(0, 0, currentSize, currentSize);
    ctx.arc(center, center, radius, 0, Math.PI * 2, true);
    ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
    ctx.fill();
    ctx.restore();

    // 3. Draw The Green Ring (The Portal Edge)
    ctx.save();
    
    // Outer Glow
    ctx.beginPath();
    ctx.arc(center, center, radius, 0, Math.PI * 2);
    ctx.strokeStyle = NEON_GREEN;
    ctx.lineWidth = scaledThickness;
    ctx.shadowColor = NEON_GREEN;
    ctx.shadowBlur = 20 * ratio; 
    ctx.stroke();
    
    // Inner Tech Line
    ctx.beginPath();
    ctx.arc(center, center, radius - (scaledThickness/2) + (2 * ratio), 0, Math.PI * 2);
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 1 * ratio;
    ctx.globalAlpha = 0.8;
    ctx.stroke();
    
    ctx.restore();
  };

  useEffect(() => {
    if (image && appState === 'app') requestAnimationFrame(draw);
  }, [image, scale, position, ringThickness, resolution, appState]);

  // --- Input Handlers (Mouse & Touch) ---

  const getTouchDistance = (touches) => {
    return Math.hypot(
      touches[0].clientX - touches[1].clientX,
      touches[0].clientY - touches[1].clientY
    );
  };

  // Mouse Handlers (Desktop)
  const handleMouseDown = (e) => {
    setIsDragging(true);
    setStartPan({ x: e.clientX - position.x, y: e.clientY - position.y });
  };

  const handleMouseMove = (e) => {
    if (!isDragging) return;
    e.preventDefault(); 
    setPosition({ x: e.clientX - startPan.x, y: e.clientY - startPan.y });
  };

  const handleMouseUp = () => setIsDragging(false);

  // Touch Handlers (Mobile/Pinch)
  const handleTouchStart = (e) => {
    if (e.touches.length === 1) {
      // Single touch = Drag
      setIsDragging(true);
      setStartPan({ 
        x: e.touches[0].clientX - position.x, 
        y: e.touches[0].clientY - position.y 
      });
    } else if (e.touches.length === 2) {
      // Multi touch = Zoom
      setIsDragging(false);
      lastPinchDistance.current = getTouchDistance(e.touches);
    }
  };

  const handleTouchMove = (e) => {
    e.preventDefault(); // Prevent scrolling
    
    if (e.touches.length === 1 && isDragging) {
      // Pan
      setPosition({ 
        x: e.touches[0].clientX - startPan.x, 
        y: e.touches[0].clientY - startPan.y 
      });
    } else if (e.touches.length === 2) {
      // Pinch Zoom
      const currentDistance = getTouchDistance(e.touches);
      if (lastPinchDistance.current !== null) {
        const delta = currentDistance - lastPinchDistance.current;
        const sensitivity = 0.005; 
        // Update scale based on pinch delta, clamped between 0.5 and 3
        const newScale = Math.min(Math.max(0.5, scale + delta * sensitivity), 3);
        setScale(newScale);
      }
      lastPinchDistance.current = currentDistance;
    }
  };

  const handleTouchEnd = () => {
    setIsDragging(false);
    lastPinchDistance.current = null;
  };

  const handleSaveAs = async () => {
    if (!canvasRef.current) return;
    const safeName = (fileName.trim() || 'XMEME_PORTAL_PFP') + '.png';
    if ('showSaveFilePicker' in window) {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: safeName,
          types: [{ description: 'PNG Image', accept: { 'image/png': ['.png'] } }],
        });
        const writable = await handle.createWritable();
        const blob = await new Promise(resolve => canvasRef.current.toBlob(resolve));
        await writable.write(blob);
        await writable.close();
        return; 
      } catch (err) {
        if (err.name !== 'AbortError') console.log('Legacy fallback');
        else return;
      }
    }
    const link = document.createElement('a');
    link.download = safeName;
    link.href = canvasRef.current.toDataURL('image/png');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- RENDER ---
  return (
    <div className="relative min-h-screen w-full font-mono text-green-500 overflow-hidden bg-black selection:bg-green-900 selection:text-white">
      <GlitchStyles />

      {/* --- PHASE 1: START SCREEN --- */}
      {appState === 'start' && (
        <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-green-900/20 to-black">
             {/* Preload Video Hidden */}
             <video 
                ref={videoRef}
                src={SPLASH_VIDEO_URL} 
                preload="auto" 
                className="hidden" 
                playsInline
             />
             
             <div className="relative group cursor-pointer" onClick={handleStart}>
                <div className="absolute inset-0 bg-green-500/20 blur-xl rounded-full animate-pulse group-hover:bg-green-500/40 transition-all duration-500"></div>
                <button 
                    className="relative px-12 py-6 bg-black border-2 border-green-500 rounded-lg overflow-hidden group hover:scale-105 transition-transform duration-300"
                >
                    <div className="absolute inset-0 bg-[linear-gradient(45deg,transparent_25%,rgba(0,255,0,0.3)_50%,transparent_75%)] bg-[length:250%_250%] animate-[shimmer_2s_infinite]"></div>
                    <h1 className="text-2xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-[#ccffcc] tracking-tighter flex items-center gap-4">
                        <Zap className="w-8 h-8 md:w-12 md:h-12 text-green-500 animate-bounce" />
                        POWER UP_PORTAL
                    </h1>
                </button>
             </div>
             <p className="mt-8 text-green-700 text-xs tracking-[0.5em] animate-pulse">ESTABLISHING UPLINK...</p>
        </div>
      )}

      {/* --- PHASE 2: VIDEO SPLASH --- */}
      {appState === 'video' && (
        <div className="fixed inset-0 z-50 bg-black">
            <video 
                ref={videoRef}
                src={SPLASH_VIDEO_URL}
                className="w-full h-full object-cover"
                autoPlay
                playsInline
                onEnded={handleVideoEnd}
            />
            
            {/* Skip Button */}
            <button 
                onClick={handleSkip}
                className="absolute bottom-10 right-6 md:bottom-12 md:right-12 px-6 py-2 bg-black/50 backdrop-blur border border-green-500/50 text-green-400 text-sm font-bold tracking-widest hover:bg-green-500 hover:text-black transition-all group flex items-center gap-2"
            >
                <span className="glitch-text" data-text="SKIP SEQUENCE">SKIP SEQUENCE</span>
                <FastForward size={14} className="group-hover:translate-x-1 transition-transform" />
            </button>
        </div>
      )}

      {/* --- PHASE 3: MAIN APP --- */}
      {appState === 'app' && (
        <>
          {/* 3D Background Layer (Only mounts when app starts to save resources) */}
          <ThreeBackground />

          {/* UI Layer */}
          <div className="relative z-10 min-h-screen flex flex-col items-center p-4 overflow-y-auto animate-in fade-in duration-1000">
            
            <header className="w-full max-w-2xl mt-4 mb-8 p-4 bg-black/50 backdrop-blur-md border border-green-500/30 rounded-lg flex flex-col items-center justify-center shadow-[0_0_30px_rgba(0,255,0,0.2)]">
              <div className="text-[10px] md:text-xs text-green-400 tracking-[0.3em] uppercase mb-1 opacity-80 animate-pulse font-bold">
                 XRPMan Studios Presents..
              </div>
              <h1 
                className="text-2xl md:text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-[#ccffcc] to-green-500 glitch-text text-center leading-tight pb-2"
                data-text="XMEME PORTAL GENERATOR"
              >
                XMEME PORTAL GENERATOR
              </h1>
              <div className="w-full h-[1px] bg-gradient-to-r from-transparent via-green-500 to-transparent mt-2 opacity-50"></div>
              <div className="flex w-full justify-between mt-1 px-2">
                <span className="text-[8px] text-green-600">SYS.VER.2.5_PINCH_ZOOM</span>
                <span className="text-[8px] text-green-600">ENCRYPTION: ACTIVE</span>
              </div>
            </header>

            <main className="w-full max-w-xl flex flex-col gap-6">
              
              {/* Main Interface */}
              <div 
                className="relative w-full aspect-square bg-black/60 rounded-xl overflow-hidden border border-green-500/50 shadow-[0_0_50px_rgba(0,255,0,0.15)] backdrop-blur-sm group"
                ref={containerRef}
              >
                {/* Corner Accents */}
                <div className="absolute top-0 left-0 w-8 h-8 border-t-2 border-l-2 border-green-500 z-20 shadow-[0_0_10px_#00ff00]"></div>
                <div className="absolute top-0 right-0 w-8 h-8 border-t-2 border-r-2 border-green-500 z-20 shadow-[0_0_10px_#00ff00]"></div>
                <div className="absolute bottom-0 left-0 w-8 h-8 border-b-2 border-l-2 border-green-500 z-20 shadow-[0_0_10px_#00ff00]"></div>
                <div className="absolute bottom-0 right-0 w-8 h-8 border-b-2 border-r-2 border-green-500 z-20 shadow-[0_0_10px_#00ff00]"></div>

                {!image ? (
                  <div 
                    onClick={() => fileInputRef.current?.click()}
                    className="absolute inset-0 flex flex-col items-center justify-center cursor-pointer hover:bg-green-900/10 transition-colors gap-4 z-30"
                  >
                    <div className="w-20 h-20 border border-dashed border-green-500/50 rounded-full flex items-center justify-center animate-pulse shadow-[0_0_20px_rgba(0,255,0,0.1)]">
                       <Upload className="w-8 h-8 text-green-500" />
                    </div>
                    <p className="text-green-400 font-bold tracking-[0.2em] text-sm text-shadow-glow">INITIALIZE UPLOAD</p>
                    <p className="text-green-600 text-[10px] uppercase font-mono">Accepts JPG / PNG Data</p>
                  </div>
                ) : (
                  <canvas
                    ref={canvasRef}
                    width={resolution}
                    height={resolution}
                    className={`w-full h-full object-contain touch-none relative z-10 ${isDragging ? 'cursor-grabbing' : 'cursor-move'}`}
                    // Desktop Handlers
                    onMouseDown={handleMouseDown}
                    onMouseMove={handleMouseMove}
                    onMouseUp={handleMouseUp}
                    onMouseLeave={handleMouseUp}
                    // Mobile Handlers
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                  />
                )}
                
                {/* Scanline Effect */}
                <div className="absolute inset-0 pointer-events-none bg-[linear-gradient(transparent_50%,rgba(0,255,0,0.05)_50%)] bg-[length:100%_4px] z-20"></div>
              </div>

              {/* Controls HUD */}
              {image && (
                <div className="bg-black/60 backdrop-blur-md p-6 rounded-xl border border-green-500/30 shadow-lg space-y-6 relative overflow-hidden animate-in slide-in-from-bottom-4 fade-in duration-500">
                   <div className="absolute -top-10 -right-10 w-32 h-32 bg-green-500/10 blur-3xl rounded-full pointer-events-none"></div>

                  <div className="grid gap-6">
                    <div className="space-y-2">
                      <div className="flex justify-between text-[10px] uppercase tracking-widest text-green-400 font-bold">
                        <span className="flex items-center gap-2"><ZoomIn size={12}/> Zoom Level</span>
                        <span>{Math.round(scale * 100)}%</span>
                      </div>
                      <input 
                        type="range" 
                        min="0.5" 
                        max="3" 
                        step="0.01" 
                        value={scale} 
                        onChange={(e) => setScale(parseFloat(e.target.value))}
                        className="w-full h-1 bg-green-900/50 rounded-lg appearance-none cursor-pointer accent-green-500 hover:accent-green-400"
                      />
                    </div>

                    <div className="space-y-2">
                      <div className="flex justify-between text-[10px] uppercase tracking-widest text-green-400 font-bold">
                        <span className="flex items-center gap-2"><RefreshCw size={12}/> Portal Width</span>
                        <span>{ringThickness}px</span>
                      </div>
                      <input 
                        type="range" 
                        min="5" 
                        max="50" 
                        step="1" 
                        value={ringThickness} 
                        onChange={(e) => setRingThickness(parseInt(e.target.value))}
                        className="w-full h-1 bg-green-900/50 rounded-lg appearance-none cursor-pointer accent-green-500 hover:accent-green-400"
                      />
                    </div>
                  </div>

                  <div className="space-y-4 pt-2 border-t border-green-900/30">
                    <div className="space-y-2">
                       <div className="flex justify-between text-[10px] uppercase tracking-widest text-green-400 font-bold">
                            <span className="flex items-center gap-2"><Monitor size={12}/> Output Resolution</span>
                        </div>
                        <div className="grid grid-cols-3 gap-2">
                            {resolutionOptions.map((opt) => (
                                <button
                                    key={opt.value}
                                    onClick={() => setResolution(opt.value)}
                                    className={`
                                        py-2 text-[10px] font-bold uppercase tracking-wider rounded border transition-all
                                        ${resolution === opt.value 
                                            ? 'bg-green-500 text-black border-green-500 shadow-[0_0_15px_rgba(0,255,0,0.4)]' 
                                            : 'bg-black/50 text-green-600 border-green-900 hover:border-green-500 hover:text-green-400'
                                        }
                                    `}
                                >
                                    {opt.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="space-y-2">
                        <div className="flex justify-between text-[10px] uppercase tracking-widest text-green-400 font-bold">
                            <span className="flex items-center gap-2"><FileText size={12}/> Save As Filename</span>
                            <span className="text-[9px] text-green-700">.PNG</span>
                        </div>
                        <div className="relative group">
                            <input 
                              type="text" 
                              value={fileName}
                              onChange={(e) => setFileName(e.target.value)}
                              placeholder="ENTER_FILENAME"
                              className="w-full bg-black/50 border border-green-800 text-green-400 p-2 rounded text-xs font-mono focus:outline-none focus:border-green-400 focus:shadow-[0_0_10px_rgba(0,255,0,0.2)] transition-all uppercase placeholder-green-900"
                            />
                        </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4 pt-2">
                    <button 
                      onClick={() => {
                         setImage(null);
                         if (fileInputRef.current) fileInputRef.current.value = '';
                      }}
                      className="group relative px-4 py-3 bg-black/50 overflow-hidden border border-red-900/50 hover:border-red-500 text-red-500/70 hover:text-red-500 rounded transition-all text-xs font-bold uppercase tracking-widest"
                    >
                      <span className="relative z-10">Abort</span>
                      <div className="absolute inset-0 bg-red-900/10 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300"></div>
                    </button>
                    
                    <button 
                      onClick={handleSaveAs}
                      className="group relative px-4 py-3 bg-green-500/10 hover:bg-green-500/20 border border-green-500 text-green-400 hover:text-white rounded transition-all text-xs font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(0,255,0,0.2)] hover:shadow-[0_0_25px_rgba(0,255,0,0.4)]"
                    >
                      <span className="relative z-10 flex items-center justify-center gap-2">
                        <Save size={14} /> SAVE DISK
                      </span>
                    </button>
                  </div>
                  
                  <div className="text-center border-t border-green-900/50 pt-4">
                       <p className="text-[9px] text-green-600/80 uppercase tracking-widest flex items-center justify-center gap-2 animate-pulse">
                          <Smartphone size={10} /> 
                          Touch interface active // Drag to calibrate
                       </p>
                  </div>

                </div>
              )}

              <input 
                type="file" 
                ref={fileInputRef} 
                onChange={handleImageUpload} 
                accept="image/*" 
                className="hidden" 
              />
              
            </main>
          </div>
        </>
      )}
    </div>
  );
};

export default App;